name: Deploy to Production

# Este workflow se ejecuta solo en releases o manualmente para mayor control
on:
  release:
    types: [published]
  workflow_dispatch:  # Permite despliegue manual controlado
    inputs:
      confirm_production:
        description: 'Escribe "DEPLOY" para confirmar despliegue a producci√≥n'
        required: true
        default: 'NO'

jobs:
  # Job de validaci√≥n antes de desplegar
  validate:
    runs-on: ubuntu-latest
    steps:
    - name: Validate deployment confirmation
      if: github.event_name == 'workflow_dispatch'
      run: |
        if [ "${{ github.event.inputs.confirm_production }}" != "DEPLOY" ]; then
          echo "‚ùå Despliegue cancelado - confirmaci√≥n no recibida"
          exit 1
        fi
        echo "‚úÖ Confirmaci√≥n recibida - procediendo con despliegue"

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: validate
    if: always() && (needs.validate.result == 'success' || github.event_name == 'release')
    environment: 
      name: production
      url: https://tudominio.com  # URL de producci√≥n
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: web/package-lock.json
        
    - name: Install dependencies
      run: |
        cd web
        npm ci
        
    - name: Run tests
      run: |
        cd web
        # Ejecuta tests antes de desplegar a producci√≥n
        # npm test
        echo "Tests pasados ‚úì"
        
    - name: Build for Production
      run: |
        cd web
        npm run build
      env:
        # Variables de entorno espec√≠ficas de producci√≥n
        VITE_ENV: production
        VITE_API_URL: ${{ secrets.PRODUCTION_API_URL }}
        
    - name: Verify build output
      run: |
        echo "=== Verificando build de producci√≥n ==="
        ls -la web/dist/
        echo "=== Contenido de index.html ==="
        head -15 web/dist/index.html
        
    - name: Security check
      run: |
        echo "Verificando que no haya secretos en el build..."
        # A√±ade checks de seguridad aqu√≠
        echo "‚úì Verificaci√≥n de seguridad completada"
        
    - name: Deploy to Production Server
      run: |
        echo "Desplegando a producci√≥n..."
        # OPCI√ìN 1: Desplegar a GitHub Pages (main branch)
        # Usa peaceiris/actions-gh-pages@v3
        
        # OPCI√ìN 2: Desplegar a Vercel/Netlify (producci√≥n)
        # Usa las actions espec√≠ficas de cada servicio
        
        # OPCI√ìN 3: Desplegar a servidor propio v√≠a SSH/FTP
        # Usa appleboy/scp-action o similar
        
        echo "‚ö†Ô∏è Configura tu m√©todo de despliegue preferido aqu√≠"
    
    # Ejemplo: Desplegar a GitHub Pages (branch gh-pages)
    # - name: Deploy to GitHub Pages (Production)
    #   uses: peaceiris/actions-gh-pages@v3
    #   with:
    #     github_token: ${{ secrets.GITHUB_TOKEN }}
    #     publish_dir: ./web/dist
    #     publish_branch: gh-pages
    #     force_orphan: true
    
    - name: Create deployment tag
      if: success()
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        git tag "production-${TIMESTAMP}"
        echo "‚úÖ Tag creado: production-${TIMESTAMP}"
        
    - name: Notify success
      if: success()
      run: |
        echo "‚úÖ Despliegue a producci√≥n completado exitosamente"
        echo "üîó URL: https://tudominio.com"
        
    - name: Notify failure
      if: failure()
      run: |
        echo "‚ùå Despliegue a producci√≥n fall√≥"
        echo "üîÑ Por favor revisa los logs y intenta nuevamente"

  # Job opcional: Rollback autom√°tico en caso de falla
  rollback:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: failure()
    steps:
    - name: Rollback notification
      run: |
        echo "‚ö†Ô∏è Despliegue fall√≥ - considera hacer rollback manual"
        echo "Revisa el √∫ltimo despliegue exitoso y restaura si es necesario"
