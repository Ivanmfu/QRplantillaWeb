name: Deploy to Staging

# Este workflow se ejecuta cuando hay cambios en la rama de staging
on:
  push:
    branches: [ staging ]
  workflow_dispatch:  # Permite ejecuci√≥n manual

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: staging  # Usa el entorno "staging" configurado en GitHub
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: web/package-lock.json
        
    - name: Install dependencies
      run: |
        cd web
        npm ci
        
    - name: Run tests
      run: |
        cd web
        # A√±ade aqu√≠ tus comandos de test si existen
        # npm test
        echo "Tests pasados ‚úì"
        
    - name: Build for Staging
      run: |
        cd web
        npm run build
      env:
        # Variables de entorno espec√≠ficas de staging
        VITE_ENV: staging
        VITE_API_URL: ${{ secrets.STAGING_API_URL }}
        
    - name: Verify build output
      run: |
        echo "=== Verificando build de staging ==="
        ls -la web/dist/
        echo "=== Contenido de index.html ==="
        head -15 web/dist/index.html
        
    - name: Deploy to Staging Server
      run: |
        echo "Desplegando a staging..."
        # OPCI√ìN 1: Desplegar a GitHub Pages (staging branch)
        # Usa peaceiris/actions-gh-pages@v3
        
        # OPCI√ìN 2: Desplegar a Vercel/Netlify
        # Usa las actions espec√≠ficas de cada servicio
        
        # OPCI√ìN 3: Desplegar a servidor propio v√≠a SSH/FTP
        # Usa appleboy/scp-action o similar
        
        echo "‚ö†Ô∏è Configura tu m√©todo de despliegue preferido aqu√≠"
        
    # Ejemplo: Desplegar a GitHub Pages (branch gh-pages-staging)
    # - name: Deploy to GitHub Pages (Staging)
    #   uses: peaceiris/actions-gh-pages@v3
    #   with:
    #     github_token: ${{ secrets.GITHUB_TOKEN }}
    #     publish_dir: ./web/dist
    #     publish_branch: gh-pages-staging
    #     force_orphan: true
    
    - name: Notify deployment
      if: success()
      run: |
        echo "‚úÖ Despliegue a staging completado exitosamente"
        echo "üîó URL: https://staging.tudominio.com"
        
    - name: Notify failure
      if: failure()
      run: |
        echo "‚ùå Despliegue a staging fall√≥"
